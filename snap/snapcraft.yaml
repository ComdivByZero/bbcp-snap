name: bbcb
title: BlackBox IDE
base: core18
adopt-info: blackbox
license: BSD-2-Clause
icon: snap/gui/blackbox.svg
summary: BlackBox Component Builder - Component Pascal IDE
description: |
  BlackBox Component Builder is an open-source IDE and a framework (collection of modules)
  written in the programming language Component Pascal which is a descendant of languages
  Oberon←Modula-2←Pascal developed by Niklaus Wirth.
  BlackBox provides facilities for document creation,
  program compilation, module execution, and interface design. Component Pascal is module
  based. Each module is a unit of compilation and a unit of execution. There is no explicit
  linker. Modules are brought into memory when specified. There is no need for "header"
  files. Symbol files are automatically generated by the compiler for those elements of a
  module that are specifically marked to be exported.
  .
  The component classes (e.g. for text or form components) follow the principle of black box
  inheritance (interface inheritance instead of implementation inheritance), hence the name
  "BlackBox".
  .
  The compiler is very fast. The language is strongly typed. Data structures are automatically
  garbage collected when no longer referenced. The framework comes with a complete set of
  documents explaining the meaning and use of each module.

grade: devel
confinement: strict

architectures:
  - build-on: amd64

parts:
  i386:
    plugin: nil
    source: .
    override-build: |
      dpkg --add-architecture i386
      apt update

  desktop-gtk2:
    after: [i386]
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: gtk
    override-pull: |
      snapcraftctl pull
      git apply $HOME/parts/i386/build/snap/local/snapcraft-desktop-helpers.patch
    plugin: make
    make-parameters:
      - "FLAVOR=gtk2"
      - "CFLAGS=-m32"
      - "LIB_DIR=usr/lib/i386-linux-gnu"
      - "CODE_AFTER_INIT='ARCH=i386-linux-gnu'"
    build-packages:
      - build-essential
      - libgtk2.0-dev
      - gcc-multilib
    stage-packages:
      - libxkbcommon0:i386  # XKB_CONFIG_ROOT
      - libgtk2.0-0:i386
      - gtk2-engines:i386
      - gtk2-engines-murrine:i386
      - libcanberra-gtk-module:i386

  blackbox:
    after: [desktop-gtk2]
    source: https://github.com/bbcb/bbcp.git
    override-pull: |
      snapcraftctl pull
      git apply $HOME/parts/i386/build/snap/local/blackbox.patch
      cp -r $HOME/parts/i386/build/snap/local/System BlackBox/
    plugin: nil
    override-build: |
      VERSION="`cat dev/AppVersion.txt | tr '\r\n' '\n'`"
      snapcraftctl set-version "$VERSION"
      cd BlackBox
      ./switch-target Linux Interp && ./build && ./export ../Linux_Interp || true
      cd ../examples/append
      echo "DevCompiler.CompileThis Init" | ./runc
      subst() {
        FILEPATH="../../BlackBox/System/Rsrc" FILENAME='Strings.odc' \
        KEY="$1" VALUE="$2" ./runc
      }
      subst appVersion "$VERSION"
      subst buildNum 7
      subst buildDate "`date +%Y-%m-%d`"
      cd ../../BlackBox
      ./switch-target none         && ./clean
      ./switch-target Linux GUI    && ./build
      ./export $SNAPCRAFT_PART_INSTALL/usr/lib/blackbox || true # TODO fix BlackBox absense error
    build-packages:
      - pax
      - libgtk2.0-dev
    stage-packages:
      - libnotify-bin
    stage:
      - -usr/bin/update-mime-database
      - -usr/share/doc/shared-mime-info/shared-mime-info-spec.pdf

  russian:
    after: [blackbox]
    source: https://github.com/bbcb/russian.git
    plugin: nil
    override-build: |
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/lib/blackbox
      cp -r * $SNAPCRAFT_PART_INSTALL/usr/lib/blackbox/
      cd $SNAPCRAFT_PART_INSTALL/usr/lib/blackbox
      rm README links.sh make-deb.sh Dev/Docu/ru/P-S-I.odc

apps:
  bbcb:
    command: bin/desktop-launch $SNAP/usr/lib/blackbox/run-BlackBox
    environment:
      LC_ALL: "C.UTF-8"
      DISABLE_WAYLAND: 1
    plugs:
      - home
      - cups-control
      - desktop
      - desktop-legacy
      - x11
      - unity7
      - network
      - gsettings
      - mount-observe
      - network-control

plugs:
  gtk-2-engines:
    interface: content
    target: $SNAP/lib/i386-linux-gnu/gtk-2.0
    default-provider: gtk2-common-themes
  gtk-2-themes:
    interface: content
    target: $SNAP/share/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/share/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/share/sounds
    default-provider: gtk-common-themes
